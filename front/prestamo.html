<!DOCTYPE html>
<head>
    <title>Préstamo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
</head>
<body>
    <header></header>
    <section>
        <div class="container is-max-tablet my-6">
            <article class="message">
                <div class="message-header is-flex is-justify-content-center">
                    <h1 id="id_prestamo" class="title has-text-white">
                        ID PRÉSTAMO: 
                    </h1>
                </div>
                <div class="message-body is-flex is-justify-content-center px-3">
                    <form id="formulario" disabled>
                        <div class="columns is-7 has-2-cols">
                            <div class="column">
                                <div class="field">
                                    <label class="label is-size-4">Fecha de Préstamo</label>
                                    <div class="control">
                                    <input id="fecha_prestamo" class="input" type="date" name="fecha_prestamo" required>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-size-4">Fecha de Devolución</label>
                                    <div class="control">
                                    <input id="fecha_devolucion" class="input" type="date" name="fecha_devolucion" required>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-size-4">Garantía</label>
                                    <div class="control">
                                    <input id="garantia" class="input" type="number" name="garantia" required>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label is-size-4">ID socio</label>
                                    <div class="control">
                                        <input id="socio_id" class="input" type="number" name="socio_id" required>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-size-4">ID libro</label>
                                    <div class="control">
                                        <input id="libro_id" class="input" type="number" name="libro_id" required>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label is-size-4">Tipo de préstamo</label>
                                    <div class="textContent">
                                        <p id="tipo_prestamo"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label is-size-4">Estado</label>
                            <p id="estado"></p>
                        </div>
                    </form>
                </div>
                <div class="message-footer">
                    <div class="buttons has-addons is-centered">
                        <button id="boton1" class="button is-fullwidth" onclick="editarPrestamo()">Editar</button>
                    </div>
                </div>
            </article>
        </div>
    </section>
    <footer class="footer"  style="padding-bottom: 1.5rem; padding-top: 1.5rem;"></footer>
    <script src="./src/header_footer.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const prestamoId = urlParams.get('id');
        
        if (!prestamoId) {
            alert("ID no válido");
            window.location.href = "informacion-socio.html";
        }
        document.getElementById('id_prestamo').textContent += prestamoId;
        
        llenarFormulario = function() {
            fetch(`http://localhost:3000/prestamos/${prestamoId}`)
            .then((Response) => Response.json())
            .then(prestamo =>{
                document.getElementById('garantia').value = prestamo.garantia;
                document.getElementById('estado').textContent = prestamo.estado;
                document.getElementById('tipo_prestamo').textContent = prestamo.tipo_prestamo;
                document.getElementById('socio_id').value = prestamo.socio_id;
                document.getElementById('libro_id').value = prestamo.libro_id;
            })
        }

        editarPrestamo = function() {
            let formulario = document.getElementById('formulario');
            let boton = document.getElementById('boton1');

            if (formulario.style.pointerEvents === 'none') {
                // Se modifica para que se pueda editar el form
                boton.textContent = 'Guardar cambios';
                formulario.style.pointerEvents = 'auto';

            } else {
                // Se modifica para que no se pueda editar el form
                boton.disabled = true;
                boton.addEventListener('click', actualizarPrestamo);
                boton.textContent = 'Editar';
                boton.disabled = false;
                formulario.style.pointerEvents = 'none';
            }
        }

        window.onload = function() {
            const fechaPrestamo = new Date().toISOString().split('T')[0]; 
            document.getElementById('fecha_prestamo').value = fechaPrestamo;

            const fechaDevolucion = new Date().toISOString().split('T')[0]; 
            document.getElementById('fecha_devolucion').value = fechaDevolucion;
        
            let formulario = document.getElementById('formulario');
            //Setea que no se pueda editar de base el form
            formulario.style.pointerEvents = 'none';
        };

        async function actualizarPrestamo(event) {
            event.preventDefault();
            let fechaDevolucion = document.getElementById('fecha_devolucion').value;
            const garantia = document.getElementById('garantia').value;
            
            //Se le asigna el formato a las fechas
            const formatoFecha = "T00:00:00.000Z";
            fechaDevolucion = fechaDevolucion.concat(formatoFecha);

            const prestamoData = {
                fecha_devolucion: fechaDevolucion,
                garantia: parseInt(garantia)
            };

            try {
                const response = await fetch(`http://localhost:3000/prestamos/${prestamoId}`, { 
                    method: 'PUT',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(prestamoData),
                });

                const prestamoActualizado = await response.json();
                if (prestamoActualizado.success) {
                    alert('¡El préstamo ha sido actualizado correctamente!');
                } else {
                    alert('Error al actualizar el préstamo.');
                }
            } catch (error) {
                console.error('Error al enviar la solicitud:', error);
                alert('No se pudo conectar con el servidor.');
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            llenarFormulario();
        })

    </script>
</body>
</html>