<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Prestamos</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    </head>
<body>
    <header>
        <!--header por header_footer.js-->
    </header>
    <section class="section is-medium">
        <div class="container">
            <div class="columns is-8">
                <div class="column">
                <h1 class="title">Lista de prestamos</h1></div>
                <div class="column">
                <div class="control ">
                    <div class="select">
                        <select id="estado-busqueda" class="select" onchange="cargarDatos()" required>
                            <option value="todos">Sin filtro</option>
                            <option value="En préstamo">En préstamo</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="En reclamo">En reclamo</option>
                        </select>
                    </div>
                </div></div>
            </div>
            <div class="table-container">
                <table class="table is-striped is-hoverable">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Titulo</th>
                            <th>Socio</th>
                            <th>Fecha prestamo</th>
                            <th>Fecha devolución</th>
                        </tr>
                        <tbody id="tabla-prestamos">
                        </tbody>
                    </thead>
                </table>
                <p id="error"></p>
            </div>
        </div>
    </section>
    <footer class="footer">
        <!--footer por header_footer.js-->
    </footer>

    <script src="./src/header_footer.js" style="padding-bottom: 1.5rem; padding-top: 1.5rem;"></script>
    <script>
        let tablaPrestamos = document.getElementById('tabla-prestamos');

        async function devolverTituloLibro(idLibro) {
            try{
                const infoLibro = await fetch(`http://localhost:3000/libros/${idLibro}`);
                const libro = await infoLibro.json();
                const nombreLibro = libro.titulo;
                return nombreLibro;

            } catch (error){
                console.error('No se pudo obtener el título del libro');
            }
        }

        async function devolverNombreSocio(idSocio) {
            try{
                const infoSocio = await fetch(`http://localhost:3000/socios?id=${idSocio}`);
                const socio = await infoSocio.json();
                const nombreEnteroSocio = socio.id + '-' + socio.nombre + ' ' + socio.apellido;
                return nombreEnteroSocio;

            } catch (error){
                console.error('No se pudo obtener el título del libro');
            }
        }

        function cargarDatos() {
            tablaPrestamos.innerHTML = ' ';

            fetch('http://localhost:3000/prestamos')
            .then((response) => response.json())
            .then((data) => {
                if (data.length === 0) {
                    const error = document.getElementById('error');
                    error.innerHTML = 'No hay prestamos :C';
                }
                else{
                const table = document.querySelector('table tbody');
                const estadoBuscado = document.getElementById('estado-busqueda').value;
                const elementoElegido = document.getElementById('estado-busqueda').value;

                data.forEach(prestamo => {        
                    if(prestamo.estado === elementoElegido || elementoElegido === "todos"){
                        devolverTituloLibro(prestamo.libro_id).then(tituloLibro => {
                            devolverNombreSocio(prestamo.socio_id).then( nombreSocio => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${prestamo.id}</td>
                                    <td>${tituloLibro}</td>
                                    <td>${nombreSocio}</td>
                                    <td>${prestamo.fecha_prestamo}</td>
                                    <td>${prestamo.fecha_devolucion}</td>
                                `;
                                table.appendChild(row);     
                            })
                        });
                    }
                });
            }
            });
        }

        window.onload = function() {
          cargarDatos(); 
        };


    </script>
</body>
</html>
