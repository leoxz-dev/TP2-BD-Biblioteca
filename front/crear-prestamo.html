<!DOCTYPE html>

<head>
    <title>Crear Préstamo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
</head>

<body>
    <header></header>

    <div class="container py-6">
        <div class="columns">
            <div class="column is-two-fifths">
                <h1 class="title">Buscar libro</h1>
                <form>
                    <div class="field has-addons">
                        <p class="control">
                          <input class="input" type="text" placeholder="Búsqueda">
                        </p>
                        <p class="control">
                            <input class="button" type="submit" value="Buscar" />
                        </p>
                    </div>
                </form>
            </div>
            <div class="column">
                <article class="message">
                    <div class="message-header is-justify-content-center">
                        <h1 class="title has-text-white">
                            NUEVO PRÉSTAMO
                        </h1>
                    </div>
                    <div class="message-body">
                        <form id="crear-prestamo">
                            <div class="field">
                                <label class="label">Fecha de Préstamo</label>
                                <div class="control">
                                    <input id="fecha_prestamo" class="input" type="date" max="2030-12-31" name="fecha_prestamo" required>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Fecha de Devolución</label>
                                <div class="control">
                                    <input id="fecha_devolucion" class="input" type="date" max="2030-12-31" name="fecha_devolucion"required>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">ID socio</label>
                                <div class="control">
                                    <input id="socio_id" class="input" type="number" min="1" name="socio_id" placeholder="123" pattern="[0-9]{1,10}" required/>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">ID Libro</label>
                                <div class="control">
                                    <input id="libro_id" class="input" type="number" min="1" name="libro_id" placeholder="46" pattern="[0-9]{1,10}" required>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">Garantía</label>
                                <div class="control">
                                    <input id="garantia" class="input" type="number" min="0" name="garantia" pattern="[0-9]{0,10}" required>
                                </div>
                                   <div class="field">
                                      <label class="label">Tipo de préstamo</label>
                                        <div class="control">
                                            <div class="select">
                                                <select id="tipo_prestamo" name="tipo_prestamo" required>
                                                    <option value="Préstamo a domicilio o individual">Préstamo a domicilio o individual</option>
                                                    <option value="Préstamo interbibliotecario">Préstamo interbibliotecario</option>
                                                    <option value="Préstamo intercampus (sólo en Bibliotecas Universitarias)">Préstamo intercampus (sólo en Bibliotecas Universitarias)</option>
                                                    <option value="Préstamo en red">Préstamo en red</option>
                                                    <option value="Préstamo colectivo">Préstamo colectivo</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">Estado</label>
                                        <div class="control">
                                            <div class="select">
                                                <select id="estado" name="estado">
                                                    <option value="En préstamo">En préstamo</option>
                                                    <option value="Finalizado">Finalizado</option>
                                                    <option value="En reclamo">En reclamo</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="control">
                                        <input class="button is-success is-fullwidth" type="submit"
                                            value="Crear préstamo" />
                                    </div>
                        </form>
                    </div>
                </article>
            </div>
        </div>
    </div>
    </div>


    <footer class="footer" style="padding-bottom: 1.5rem; padding-top: 1.5rem;"></footer>
    <script src="./src/header_footer.js"></script>
    <script>
        document.getElementById('crear-prestamo').addEventListener('submit', async function (event) {
            event.preventDefault();
            //SACAMOS LOS DATOS DE LOS INPUTS DEL FORM
            let fechaPrestamo = document.getElementById('fecha_prestamo').value;
            let fechaDevolucion = document.getElementById('fecha_devolucion').value;
            const garantia = document.getElementById('garantia').value;
            const estado = document.getElementById('estado').value;
            const tipoPrestamo = document.getElementById('tipo_prestamo').value;
            const idSocio = document.getElementById('socio_id').value;
            const idLibro = document.getElementById('libro_id').value;

            //Se le asigna el formato a las fechas
            const formatoFecha = "T00:00:00.000Z";
            fechaPrestamo = fechaPrestamo.concat(formatoFecha);
            fechaDevolucion = fechaDevolucion.concat(formatoFecha);

            //CREAMOS UN BODY CON ESOS DATOS
            const prestamoData = {
                fecha_prestamo: fechaPrestamo,
                fecha_devolucion: fechaDevolucion,
                estado: estado,
                garantia: parseInt(garantia),
                tipo_prestamo: tipoPrestamo,
                socio_id: parseInt(idSocio),
                libro_id: parseInt(idLibro)
            };

            //INTENTAMOS HACER UN POST UTILIZANDO COMO BODY EL prestamoData JSONIFICADO
            try {
                console.log(prestamoData);

                const response = await fetch('http://localhost:3000/prestamos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    //JSONIFICACION
                    body: JSON.stringify(prestamoData),

                });
                //response.ok SE FIJA SI EL STATUS RESPONSE ESTA ENTRE 200 Y 299
                if (response.ok) {
                    const nuevoPrestamo = await response.json();
                    console.log(nuevoPrestamo);
                    alert(`¡Préstamo creado con éxito! ID: ${nuevoPrestamo.id}`);
                    //SI TODO VA BIEN Y EL PRESTAMO SE CREA ENTONCES USAMOS LA FUNCION actualizarEjemplares
                    //Y RESTA 1 A LA CANTIDAD
                    await actualizarEjemplares(idLibro);
                    //LIMPIAMOS EL FORM
                    document.getElementById('crear-prestamo').reset();
                } else {
                    const error = await response.json();
                    alert(`Error al crear socio: ${response.status}`);
                }
                //EN CASO DE QUE ALGO SALE MAL CON EL FETCH EL CATCH AGARRA EL ERROR Y MUESTA UN MENSAJE AL USUARIO 
            } catch (error) {
                console.error('Error al enviar la solicitud:', error);
                alert('No se pudo conectar con el servidor.');
            }
        })

        //FUNCION PARA RESTARLE 1 A CANT-EJEMPLARES CUANDO SE HAGA EL PRESTAMO
        async function actualizarEjemplares(idLibro) {
            try {
                //OBTENEMOS CANT-EJEMPLARES
                const responseGet = await fetch(`http://localhost:3000/libros/${idLibro}`);
                if (!responseGet.ok) {
                    alert(`Error al obtener información del libro: ${responseGet.status}`);
                    return;
                }

                const libro = await responseGet.json();
                //RESTAMOS 1 A LA CANT-EJEMPLARES DEL LIBRO QUE SE ESTA PRESTANDO
                const nuevaCantidad = parseInt( libro.cant_ejemplares) - 1; 
                //SI YA NO HAY EJEMPLARES LE AVISA AL USUARIO
                if (nuevaCantidad < 0) {
                    alert('No hay ejemplares disponibles para prestar.');
                    return;
                }
                console.log('Nuevo valor de cantidad de ejemplares:', nuevaCantidad);

                //USAMOS PUT PARA ACTUALIZAR LA CANT-EJEMPLARES POR nuevaCantidad
                const responsePut = await fetch(`http://localhost:3000/libros/${idLibro}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cant_ejemplares: nuevaCantidad })
                });
                if (responsePut.ok) {
                    console.log(`Cantidad de ejemplares del libro ${idLibro} actualizada a ${nuevaCantidad}.`);
                } else {
                    const error = await responsePut.json();
                    alert(`Error al actualizar cantidad de ejemplares: ${responsePut.status} - ${error.message}`);
                }
            } catch (error) {
                console.error('Error al actualizar la cantidad de ejemplares:', error);
                alert('No se pudo actualizar la cantidad de ejemplares del libro.');
            }
        }
    </script>
</body>

</html>