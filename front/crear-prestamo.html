<!DOCTYPE html>
<head>
    <title>Crear Préstamo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
</head>
<body>
    <header></header>
    <section>
        <div class="container py-6">
            <div class="columns">
                <div class="column is-two-fifths">
                    <h1 class="title">SOCIOS</h1>
                    <form>
                        <div class="field has-addons">
                            <p class="control">
                              <span class="select">
                                <select>
                                    <option>ID socio</option>
                                    <option>Email</option>
                                </select>
                              </span>
                            </p>
                            <p class="control">
                              <input class="input" type="text" placeholder="Búsqueda">
                            </p>
                            <p class="control">
                                <input class="button" type="submit" value="Buscar"/>
                            </p>
                        </div>
                    </form>
                </div>
                <div class="column">
                        <article class="message">
                            <div class="message-header">
                                <h1 class="title has-text-white">
                                    ID PRESTAMO: Cdgo de Préstamo
                                </h1>
                            </div>
                            <div class="message-body">
                                <form id="crear-prestamo">
                                    <div class="field">
                                        <label class="label">Fecha de Préstamo</label>
                                        <div class="control">
                                          <input id="fecha_prestamo" class="input" type="date" name="fecha_prestamo">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">Fecha de Devolución</label>
                                        <div class="control">
                                          <input id="fecha_devolucion" class="input" type="date" name="fecha_devolucion">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">ID socio</label>
                                        <div class="control">
                                          <input id="socio_id" class="input" type="number" name="socio_id">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">ID Libro</label>
                                        <div class="control">
                                          <input id="libro_id" class="input" type="number" name="socio_id">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">Extensión de tiempo</label>
                                        <div class="control">
                                          <input class="input" type="time" name="tiempo_agregado">
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">Tipo de préstamo</label>
                                        <div class="control">
                                          <div class="select">
                                            <select>
                                                <option>Préstamo a domicilio o individual</option>
                                                <option>Préstamo interbibliotecario</option>
                                                <option>Préstamo intercampus (sólo en Bibliotecas Universitarias)</option>
                                                <option>Préstamo en red</option>
                                                <option>Préstamo colectivo</option>
                                            </select>
                                          </div>
                                        </div>
                                    </div><br>
                                    <div class="control has-text-centered">
                                        <input class="button is-success is-fullwidth" type="submit" value="Crear préstamo"/>
                                    </div>
                                </form>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <footer class="footer"></footer>
    <script src="./src/header_footer.js"></script>
    <script>
        document.getElementById('crear-prestamo').addEventListener('submit', async function(event) {
            event.preventDefault();
            //SACAMOS LOS DATOS DE LOS INPUTS DEL FORM
            let fechaPrestamo = document.getElementById('fecha_prestamo').value;
            let fechaDevolucion = document.getElementById('fecha_devolucion').value;
            const idSocio = document.getElementById('socio_id').value;
            const idLibro = document.getElementById('libro_id').value;
            //Faltan las opciones de selección y la extensión de tiempo
            
            //Se le asigna el formato a las fechas
            const formatoFecha = "T00:00:00.000Z";
            fechaPrestamo = fechaPrestamo.concat(formatoFecha);
            fechaDevolucion = fechaDevolucion.concat(formatoFecha);

            //CREAMOS UN BODY CON ESOS DATOS
            const prestamoData = {
                socio_id: parseInt(idSocio),
                libro_id: parseInt(idLibro),
                fecha_prestamo: fechaPrestamo,
                fecha_devolucion: fechaDevolucion
            };
            //INTENTAMOS HACER UN POST UTILIZANDO COMO BODY EL prestamoData JSONIFICADO
            try {
                const response = await fetch('http://localhost:3000/prestamos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    //JSONIFICACION
                    body: JSON.stringify(prestamoData),
                });
                //response.ok SE FIJA SI EL STATUS RESPONSE ESTA ENTRE 200 Y 299
                if (response.ok) {
                    const nuevoPrestamo = await response.json();
                    alert(`¡Préstamo creado con éxito! ID: ${nuevoPrestamo.id}`);
                    //LIMPIAMOS EL FORM
                    document.getElementById('crear-prestamo').reset();
                } else {
                    const error = await response.json();
                    alert(`Error al crear socio: ${response.status}`);
                    }
            //EN CASO DE QUE ALGO SALE MAL CON EL FETCH EL CATCH AGARRA EL ERROR Y MUESTA UN MENSAJE AL USUARIO 
            } catch (error) {
                console.error('Error al enviar la solicitud:', error);
                alert('No se pudo conectar con el servidor.');
            }
        })
    </script>
</body>
</html> 