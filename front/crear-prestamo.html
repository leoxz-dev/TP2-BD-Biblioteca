<!DOCTYPE html>
<head>
    <title>Crear Préstamo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
</head>
<body>
    <header></header>
    
    <div class="container py-6">
        <div class="columns">
            <div class="column is-two-fifths">
                <h1 class="title">SOCIOS</h1>
                <form>
                    <div class="field has-addons">
                        <p class="control">
                          <span class="select">
                            <select>
                                <option>ID socio</option>
                                <option>Email</option>
                            </select>
                          </span>
                        </p>
                        <p class="control">
                          <input class="input" type="text" placeholder="Búsqueda">
                        </p>
                        <p class="control">
                            <input class="button" type="submit" value="Buscar"/>
                        </p>
                    </div>
                </form>
            </div>
            <div class="column">
                    <article class="message">
                        <div class="message-header is-justify-content-center">
                            <h1 class="title has-text-white">
                                NUEVO PRÉSTAMO
                            </h1>
                        </div>
                        <div class="message-body">
                            <form id="crear-prestamo">
                                <div class="field">
                                    <label class="label">Fecha de Préstamo</label>
                                    <div class="control">
                                      <input id="fecha_prestamo" class="input" type="date" name="fecha_prestamo">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Fecha de Devolución</label>
                                    <div class="control">
                                      <input id="fecha_devolucion" class="input" type="date" name="fecha_devolucion">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">ID socio</label>
                                    <div class="control">
                                      <input id="socio_id" class="input" type="number"  min="1" name="socio_id">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">ID Libro</label>
                                    <div class="control">
                                      <input id="libro_id" class="input" type="number" min="1" name="libro_id">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Garantía</label>
                                    <div class="control">
                                      <input id="garantia" class="input" type="number" min="0" max="10000" name="garantia">
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Estado</label>
                                    <div class="control">
                                        <div class="select">
                                            <select id="estado" name="estado">
                                                <option>En préstamo-con garantía paga</option>
                                                <option>En préstamo-sin garantía paga</option>
                                                <option>Finalizado</option>
                                                <option>Atrasado</option>
                                            </select>
                                          </div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Tipo de préstamo</label>
                                    <div class="control">
                                      <div class="select">
                                        <select id="tipo_prestamo" name="tipo_prestamo">
                                            <option>Préstamo a domicilio o individual</option>
                                            <option>Préstamo interbibliotecario</option>
                                            <option>Préstamo intercampus (sólo en Bibliotecas Universitarias)</option>
                                            <option>Préstamo en red</option>
                                            <option>Préstamo colectivo</option>
                                        </select>
                                      </div>
                                    </div>
                                </div><br>
                                <div class="control">
                                    <input class="button is-success is-fullwidth" type="submit" value="Crear préstamo"/>
                                </div>
                            </form>
                        </div>
                    </article>
                </div>
            </div>
        </div>
    </div>


    <footer class="footer"  style="padding-bottom: 1.5rem; padding-top: 1.5rem;"></footer>
    <script src="./src/header_footer.js"></script>
    <script>
        document.getElementById('crear-prestamo').addEventListener('submit', async function(event) {
            event.preventDefault();
            //SACAMOS LOS DATOS DE LOS INPUTS DEL FORM
            let fechaPrestamo = document.getElementById('fecha_prestamo').value;
            let fechaDevolucion = document.getElementById('fecha_devolucion').value;
            const garantia = document.getElementById('garantia').value;
            const estado = document.getElementById('estado').value;
            const tipoPrestamo = document.getElementById('tipo_prestamo').value;
            const idSocio = document.getElementById('socio_id').value;
            const idLibro = document.getElementById('libro_id').value;
            
            
            //Se le asigna el formato a las fechas
            const formatoFecha = "T00:00:00.000Z";
            fechaPrestamo = fechaPrestamo.concat(formatoFecha);
            fechaDevolucion = fechaDevolucion.concat(formatoFecha);

            //CREAMOS UN BODY CON ESOS DATOS
            const prestamoData = {
                fecha_prestamo: fechaPrestamo,
                fecha_devolucion: fechaDevolucion,
                estado: estado,
                garantia: parseInt(garantia),
                tipo_prestamo: tipoPrestamo,
                socio_id: parseInt(idSocio),
                libro_id: parseInt(idLibro)
            };
            //INTENTAMOS HACER UN POST UTILIZANDO COMO BODY EL prestamoData JSONIFICADO
            try {
                const response = await fetch('http://localhost:3000/prestamos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    //JSONIFICACION
                    body: JSON.stringify(prestamoData),
                });
                //response.ok SE FIJA SI EL STATUS RESPONSE ESTA ENTRE 200 Y 299
                if (response.ok) {
                    const nuevoPrestamo = await response.json();
                    alert(`¡Préstamo creado con éxito! ID: ${nuevoPrestamo.id}`);
                    //LIMPIAMOS EL FORM
                    document.getElementById('crear-prestamo').reset();
                } else {
                    const error = await response.json();
                    alert(`Error al crear socio: ${response.status}`);
                    }
            //EN CASO DE QUE ALGO SALE MAL CON EL FETCH EL CATCH AGARRA EL ERROR Y MUESTA UN MENSAJE AL USUARIO 
            } catch (error) {
                console.error('Error al enviar la solicitud:', error);
                alert('No se pudo conectar con el servidor.');
            }
        })
    </script>
</body>
</html> 